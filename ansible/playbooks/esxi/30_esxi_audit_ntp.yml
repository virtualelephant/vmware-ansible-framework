# ---
# docmeta:
#   id: esxi_audit_ntp
#   title: "ESXi NTP Audit (via vSphere API)"
#   summary: "Reads NTP service status/policy and configured servers for ESXi hosts using the vSphere API (no SSH), and writes an audit report."
#   prerequisites:
#     - "Python package: pyvmomi (on control node)"
#     - "Ansible collection: community.vmware"
#     - "Network access from control node to vCenter"
#     - "vCenter credentials in vault or group_vars (username/password)"
#   inputs_required:
#     - "vcenter_hostname (string)"
#     - "vcenter_username / vcenter_password (string)"
#     - "esxi_hosts (list of ESXi FQDNs/hosts)"
#     - "artifacts_dir (path for output report)"
#   inputs_optional:
#     - "vcenter_port (int, default=443)"
#     - "vcenter_validate_certs (bool, default=false)"
#   outputs:
#     - "YAML report written to {{ artifacts_dir }}/ntp_audit_<timestamp>.yml"
#   examples:
#     - name: "Run audit using group_vars and vault"
#       cmd: >
#         ansible-playbook ansible/playbooks/esxi/30_esxi_audit_ntp.yml
#         -e 'artifacts_dir=artifacts'
#         --vault-password-file .ci/.vault_pass.txt
#     - name: "Override host list on the fly"
#       cmd: >
#         ansible-playbook ansible/playbooks/esxi/30_esxi_audit_ntp.yml
#         -e 'artifacts_dir=artifacts esxi_hosts=["esxi01","esxi02"]'
#   notes:
#     - "Play runs on localhost and calls vSphere APIs; ESXi SSH is not required."
# ---

---
- name: "Audit ESXi NTP via VMware API"
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../../group_vars/all/global.yml

  vars:
    timestamp: "{{ lookup('pipe','date -u +%Y%m%dT%H%M%SZ') }}"
    report_path: "{{ artifacts_dir }}/ntp_audit_{{ timestamp }}.yml"

  tasks:
    - name: Ensure artifacts dir exists
      ansible.builtin.file:
        path: "{{ artifacts_dir }}"
        state: directory
        mode: "0755"

    - name: Query NTP status and servers for each ESXi
      vmware_esxi_ntp_info:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        port: "{{ vcenter_port | default(443) }}"
        validate_certs: "{{ vcenter_validate_certs | default(false) }}"
        esxi_hostname: "{{ item }}"
      loop: "{{ esxi_hosts }}"
      register: ntp_results

    - name: Write audit report (raw results and summary)
      ansible.builtin.copy:
        dest: "{{ report_path }}"
        content: |
          results:
          {{ ntp_results | to_nice_yaml(indent=2) | indent(2) }}
          summary:
          {% for r in ntp_results.results %}
            {{ (r.esxi_hostname | default(r.item)) | string }}:
              service_key: {{ r.ansible_facts.ntp.service_key | default('ntpd') }}
              running: {{ r.ansible_facts.ntp.running | default('unknown') }}
              policy: {{ r.ansible_facts.ntp.policy | default('unknown') }}
              servers: {{ (r.ansible_facts.ntp.servers | default([])) | to_yaml | trim }}
          {% endfor %}

    - name: Display summary
      ansible.builtin.debug:
        msg: >-
          {{ (item.esxi_hostname | default(item.item)) | string }} ->
          running={{ item.ansible_facts.ntp.running | default('unknown') }}, policy={{ item.ansible_facts.ntp.policy | default('unknown') }},
          servers={{ item.ansible_facts.ntp.servers | default([]) }}
      loop: "{{ ntp_results.results }}"
