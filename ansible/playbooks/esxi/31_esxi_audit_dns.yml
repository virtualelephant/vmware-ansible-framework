# ---
# docmeta:
#   id: esxi_audit_dns
#   title: "ESXi DNS Audit & Enforce"
#   summary: "Audits ESXi DNS servers and search domains; optionally enforces desired settings through the vSphere API."
#   prerequisites:
#     - "Ansible collection: community.vmware"
#     - "Control node Python: pyvmomi"
#     - "vCenter credentials present (vars or vault)"
#   inputs_required:
#     - "vcenter_hostname (string)"
#     - "vcenter_username / vcenter_password (string)"
#     - "vcenter_validate_certs (bool)"
#     - "dns_nameservers (list)"
#     - "dns_search_domains (list)"
#   inputs_optional:
#     - "mode (string: audit|enforce, default=audit)"
#     - "esxi_hosts (inventory group/hosts to target)"
#   outputs:
#     - "Console summary of hosts that would change (audit) or were changed (enforce)"
#   examples:
#     - name: "Audit only (dry-run)"
#       cmd: >
#         ansible-playbook ansible/playbooks/esxi/31_esxi_audit_dns.yml
#         -e mode=audit
#     - name: "Enforce desired DNS settings"
#       cmd: >
#         ansible-playbook ansible/playbooks/esxi/31_esxi_audit_dns.yml
#         -e mode=enforce
#     - name: "Override values on the fly"
#       cmd: >
#         ansible-playbook ansible/playbooks/esxi/31_esxi_audit_dns.yml
#         -e 'mode=enforce dns_nameservers=["10.1.10.11","10.1.10.12"] dns_search_domains=["home.virtualelephant.com","cilium.virtualelephant.com"]'
#   notes:
#     - "Modules honor --check in audit flows; enforce mode performs idempotent changes."
# ---

---
- name: Audit or enforce DNS settings on ESXi hosts
  hosts: esxi
  gather_facts: false
  vars:
    mode: "{{ mode | default('audit') }}"  # audit | enforce
  pre_tasks:
    - name: "Assert required vars are present"
      assert:
        that:
          - dns_nameservers is defined and dns_nameservers | length > 0
          - dns_search_domains is defined and dns_search_domains | length > 0
          - vcenter_hostname is defined
          - vcenter_username is defined
          - vcenter_password is defined
        fail_msg: "Missing required vars: dns_nameservers, dns_search_domains, vCenter creds."
  tasks:
    - name: "(AUDIT) Check what would change (dry-run vmware_host_dns)"
      when: mode == 'audit'
      community.vmware.vmware_host_dns:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: "{{ vcenter_validate_certs | default(false) }}"
        esxi_hostname: "{{ inventory_hostname }}"
        dns_servers: "{{ dns_nameservers }}"
        search_domains: "{{ dns_search_domains }}"
      check_mode: true
      register: audit_dns

    - name: "Collect audit result"
      when: mode == 'audit'
      set_fact:
        esxi_dns_audit_result: >-
          {{
            (esxi_dns_audit_result | default([])) +
            [ {'host': inventory_hostname, 'would_change': audit_dns is changed} ]
          }}

    - name: "(ENFORCE) Apply DNS settings (idempotent)"
      when: mode == 'enforce'
      community.vmware.vmware_host_dns:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: "{{ vcenter_validate_certs | default(false) }}"
        esxi_hostname: "{{ inventory_hostname }}"
        dns_servers: "{{ dns_nameservers }}"
        search_domains: "{{ dns_search_domains }}"
      register: enforce_dns
      changed_when: enforce_dns is changed

  post_tasks:
    - name: "Audit summary (mode=audit)"
      when: mode == 'audit'
      debug:
        msg: >-
          {{
            esxi_dns_audit_result
              | default([])
              | selectattr('would_change','equalto',true)
              | list
          }}
      # Prints a list of hosts that WOULD change.

    - name: "Enforce summary (mode=enforce)"
      when: mode == 'enforce'
      debug:
        msg: "DNS enforcement complete on {{ ansible_play_hosts_all | length }} host(s). Changed status shown in task output."
