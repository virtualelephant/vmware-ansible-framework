---
# ---------------------------------------------------------------------------
# Title: Linux – Install & Configure containerd (Ubuntu)
# File: ansible/playbooks/linux/05_linux_install_docker.yml
#
# Summary:
#   Installs containerd on Ubuntu, generates a default config (once),
#   enforces SystemdCgroup=true and a pinned sandbox_image, wires crictl,
#   and (optionally) trusts a private Harbor registry CA.
#
# Dry-run safety:
#   - We pre-stat /etc/containerd/config.toml.
#   - In --check, we DO NOT create/modify files that don’t exist yet,
#     preventing failures in CI dry-run stages.
#   - All mutating handlers are disabled in --check.
#
# Idempotency:
#   - Default config generated only if missing.
#   - replace/edit tasks only change when drift is detected.
#   - Handlers (daemon reload / restart) trigger on change.
#
# Requirements:
#   - Ansible >= 2.14
#   - Target: Ubuntu with systemd
#
# Variables (from group_vars or inventory):
#   configure_harbor_registry: true|false (default true)
#   harbor_registry_host: e.g. "harbor.home.virtualelephant.com"
#   harbor_registry_port: e.g. 443
#   harbor_ca_src: path to org CA on controller, e.g. "files/ve-ca.crt"
#   harbor_ca_name: filename stem for OS trust store, e.g. "ve-root"
#   harbor_write_hosts_toml: true|false (default true)
#
# Example:
#   ansible-playbook ansible/playbooks/linux/05_linux_install_docker.yml \
#     -i ansible/inventories/lab/hosts.ini --limit somehost
#
#   Dry run:
#   ansible-playbook ansible/playbooks/linux/05_linux_install_docker.yml \
#     -i ansible/inventories/lab/hosts.ini --limit somehost --check --diff
# ---------------------------------------------------------------------------

- name: Docker (containerd) package install for (Ubuntu Server)
  hosts: all
  become: true
  gather_facts: true

  vars_files:
    - ../../inventories/group_vars/all.yml

  vars:
    is_check: "{{ ansible_check_mode | default(false) }}"
    containerd_config: /etc/containerd/config.toml
    sandbox_image: "registry.k8s.io/pause:3.10"

  pre_tasks:
    - name: Assert OS is Ubuntu
      ansible.builtin.assert:
        that:
          - ansible_distribution == 'Ubuntu'
        fail_msg: "This playbook targets Ubuntu. Detected {{ ansible_distribution }}."

    - name: Stat containerd config path
      ansible.builtin.stat:
        path: "{{ containerd_config }}"
      register: containerd_cfg_stat

  tasks:
    - name: Install containerd
      ansible.builtin.apt:
        name: containerd
        state: present
        update_cache: true

    - name: Ensure /etc/containerd exists
      ansible.builtin.file:
        path: /etc/containerd
        state: directory
        owner: root
        group: root
        mode: '0755'

    # Generate default config only when not in check AND file is missing/empty
    - name: Generate default containerd config if missing (normal mode only)
      ansible.builtin.shell: |
        set -euo pipefail
        containerd config default > "{{ containerd_config }}"
      args:
        executable: /bin/bash
      when:
        - not is_check
        - not containerd_cfg_stat.stat.exists or (containerd_cfg_stat.stat.size | int) == 0
      notify: Restart containerd

    # Refresh stat after a potential create
    - name: Re-stat containerd config
      ansible.builtin.stat:
        path: "{{ containerd_config }}"
      register: containerd_cfg_stat_post

    # Edits only run if the file exists (in --check on a fresh box, we skip to avoid failure)
    - name: Ensure SystemdCgroup = true in containerd config
      ansible.builtin.replace:
        path: "{{ containerd_config }}"
        regexp: '^\s*SystemdCgroup\s*=\s*false'
        replace: '            SystemdCgroup = true'
      when: containerd_cfg_stat_post.stat.exists
      notify: Restart containerd

    - name: Ensure sandbox image (pause) uses pinned version
      ansible.builtin.replace:
        path: "{{ containerd_config }}"
        regexp: 'sandbox_image\s*=\s*"[^"]+"'
        replace: 'sandbox_image = "{{ sandbox_image }}"'
      when: containerd_cfg_stat_post.stat.exists
      notify: Restart containerd

    - name: Create crictl config
      ansible.builtin.copy:
        dest: /etc/crictl.yaml
        owner: root
        group: root
        mode: '0644'
        content: |
          runtime-endpoint: unix:///run/containerd/containerd.sock
          image-endpoint: unix:///run/containerd/containerd.sock
          timeout: 10
          debug: false

    - name: Ensure ca-certificates is present
      ansible.builtin.apt:
        name: ca-certificates
        state: present

    - name: Copy organization CA to system trust (Ubuntu)
      ansible.builtin.copy:
        src: "{{ harbor_ca_src }}"
        dest: "/usr/local/share/ca-certificates/{{ harbor_ca_name }}.crt"
        owner: root
        group: root
        mode: "0644"
      when: configure_harbor_registry | default(true)
      notify: Update CA trust

    # ----- containerd registry trust -----
    - name: Create containerd certs.d base dir
      ansible.builtin.file:
        path: /etc/containerd/certs.d
        state: directory
        owner: root
        group: root
        mode: "0755"
      when: configure_harbor_registry | default(true)

    - name: Derive containerd registry directory name
      ansible.builtin.set_fact:
        _harbor_registry_dir: >-
          {{ harbor_registry_host if (harbor_registry_port | int) == 443
             else harbor_registry_host ~ ':' ~ (harbor_registry_port | string) }}
      when: configure_harbor_registry | default(true)

    - name: Create certs.d/<registry> directory
      ansible.builtin.file:
        path: "/etc/containerd/certs.d/{{ _harbor_registry_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      when: configure_harbor_registry | default(true)

    - name: Install CA for containerd registry trust
      ansible.builtin.copy:
        src: "{{ harbor_ca_src }}"
        dest: "/etc/containerd/certs.d/{{ _harbor_registry_dir }}/ca.crt"
        owner: root
        group: root
        mode: "0644"
      when: configure_harbor_registry | default(true)
      notify: Restart containerd

    - name: Write containerd hosts.toml for Harbor (optional)
      ansible.builtin.copy:
        dest: "/etc/containerd/certs.d/{{ _harbor_registry_dir }}/hosts.toml"
        owner: root
        group: root
        mode: "0644"
        content: |
          server = "https://{{ harbor_registry_host }}{{ '' if (harbor_registry_port | int) == 443 else (':' ~ (harbor_registry_port | string)) }}"

          [host."https://{{ harbor_registry_host }}{{ '' if (harbor_registry_port | int) == 443 else (':' ~ (harbor_registry_port | string)) }}"]
            capabilities = ["pull", "resolve", "push"]
            ca = "ca.crt"
      when:
        - configure_harbor_registry | default(true)
        - harbor_write_hosts_toml | default(true)
      notify: Restart containerd

  handlers:
    - name: Update CA trust
      ansible.builtin.command: update-ca-certificates
      register: update_ca_trust_result
      changed_when: >
        ('1 added' in update_ca_trust_result.stdout) or
        ('done.' in update_ca_trust_result.stdout)
      when: not is_check

    - name: Restart containerd
      ansible.builtin.systemd:
        name: containerd
        state: restarted
        enabled: true
      when: not is_check

  post_tasks:
    - name: Summary
      ansible.builtin.debug:
        msg:
          - "containerd installed and configured (SystemdCgroup=true, sandbox_image={{ sandbox_image }})"
