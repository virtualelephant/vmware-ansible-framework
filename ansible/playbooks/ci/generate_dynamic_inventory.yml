---
# =============================================================================
# Title: Generate dynamic inventory.ini from vCenter clusters/hosts
# File: ansible/playbooks/inventory/generate_dynamic_inventory.yml
# Summary:
#   Builds (or updates) an Ansible INI inventory by querying vCenter for
#   clusters and ESXi hosts using a repo-local Python helper script.
#
# Why:
#   Keeps inventory current without hand editing; supports CI/CD and git-ops
#   flows with idempotent writes and clean dry-run previews.
#
# What it does:
#   - Verifies prerequisites on the control node (pyvmomi, script presence)
#   - Executes the generator script in preview mode when --check is used
#   - Writes inventory to disk only when content really changes (idempotent)
#
# Requirements (control node):
#   - Python 3.x
#   - Package: pyvmomi (auto-installed by the playbook under `deps` tag)
#   - Network access to vCenter (TCP 443)
#
# Required variables (typically from group_vars + vault):
#   vcenter_hostname        (string)  # FQDN or IP of vCenter
#   vcenter_username        (string)
#   vcenter_password        (string, vaulted)
#
# Playbook variables (override as needed):
#   vc_gen_script: <path>            # Default: {{ playbook_dir }}/../../tools/vc_inventory_to_ini.py
#   inventory_outfile: <path>        # Default: {{ playbook_dir }}/../../inventories/inventory.ini
#   vcenter_verify_ssl: false|true   # Default: false (labs). Set true for prod.
#   generate_inventory_dry_run: bool # Default: {{ ansible_check_mode }}
#
# Tags:
#   deps, check, info, generate
#
# Idempotency:
#   The task that writes inventory sets `changed: true` only if the generator
#   reports "Wrote updated inventory" in stdout.
#
# Dry-run behavior:
#   - `ansible-playbook ... --check` runs the script with --dry-run and never
#     touches the filesystem (changed=false).
#
# CLI examples:
#   # Preview (no changes)
#   ansible-playbook ansible/playbooks/inventory/generate_dynamic_inventory.yml --check
#
#   # Generate (writes if content changed)
#   ansible-playbook ansible/playbooks/inventory/generate_dynamic_inventory.yml
#
#   # Override output path
#   ansible-playbook ansible/playbooks/inventory/generate_dynamic_inventory.yml \
#     -e inventory_outfile=ansible/inventories/inventory.ini
#
# Output:
#   - INI file at `inventory_outfile` (default: inventories/inventory.ini)
#
# Example inventory structure (snippet):
#   [esxi_hosts:children]
#   cluster01
#   cluster02
#
#   [cluster01]
#   esxi01.home.virtualelephant.com
#   esxi02.home.virtualelephant.com
#
# Troubleshooting:
#   - "Python generator script not found": ensure vc_inventory_to_ini.py exists
#     at the path in `vc_gen_script` and is executable.
#   - SSL errors: set vcenter_verify_ssl=true and ensure proper trust if required.
#
# Maintainer: Virtual Elephant Consulting, LLC
# Version: 1.0
# Last-Updated: 2025-11-04
# =============================================================================

- name: Generate dynamic inventory.ini from vCenter clusters/hosts
  hosts: localhost
  gather_facts: false

  vars_files:
    - "../../inventories/group_vars/all/global.yml"
    - "../../vault/vcenter-vault.yml"

  vars:
    # Where the generator script lives in your repo
    vc_gen_script: "{{ playbook_dir }}/../../tools/vc_inventory_to_ini.py"

    # Output location for the generated inventory
    inventory_outfile: "{{ playbook_dir }}/../../inventories/inventory.ini"

    # SSL verification (default off for labs); set to true for production
    vcenter_verify_ssl: false

    # Optional: allow forcing a dry run regardless of check mode
    generate_inventory_dry_run: "{{ ansible_check_mode | default(false) }}"

  pre_tasks:
    - name: Ensure pyvmomi is available on control node
      ansible.builtin.pip:
        name: pyvmomi
        state: present
      tags: [deps]

    - name: Assert generator script exists
      ansible.builtin.stat:
        path: "{{ vc_gen_script }}"
      register: script_stat
      tags: [check]

    - name: Fail if generator script is missing
      ansible.builtin.fail:
        msg: >-
          Python generator script not found at {{ vc_gen_script }}.
          Please add vc_inventory_to_ini.py to ansible/tools/ (or update vc_gen_script).
      when: not script_stat.stat.exists
      tags: [check]

    - name: Ensure generator script is executable
      ansible.builtin.file:
        path: "{{ vc_gen_script }}"
        mode: "0755"
      when: script_stat.stat.exists
      tags: [check]

  tasks:
    - name: Show planned output path (dry-run preview)
      ansible.builtin.debug:
        msg:
          - "vCenter: {{ vcenter_hostname }}"
          - "Output inventory: {{ inventory_outfile }}"
          - "Check mode (dry-run): {{ generate_inventory_dry_run | bool }}"
      tags: [info]

    - name: Run generator in dry-run mode (Ansible check mode or forced)
      ansible.builtin.command:
        cmd: >-
          {{ vc_gen_script }}
          --vcenter {{ vcenter_hostname }}
          --user {{ vcenter_username | quote }}
          --password {{ vcenter_password | quote }}
          {% if vcenter_verify_ssl %}--verify-ssl{% endif %}
          --dry-run
      register: gen_dry
      changed_when: false
      when: generate_inventory_dry_run | bool
      tags: [generate]

    - name: Print dry-run output
      ansible.builtin.debug:
        var: gen_dry.stdout
      when: generate_inventory_dry_run | bool
      tags: [generate]

    - name: Generate or update inventory.ini (writes only if changed)
      ansible.builtin.command:
        cmd: >-
          {{ vc_gen_script }}
          --vcenter {{ vcenter_hostname }}
          --user {{ vcenter_username | quote }}
          --password {{ vcenter_password | quote }}
          {% if vcenter_verify_ssl %}--verify-ssl{% endif %}
          --outfile {{ inventory_outfile }}
      register: gen_run
      changed_when: "'Wrote updated inventory' in gen_run.stdout"
      when: not (generate_inventory_dry_run | bool)
      tags: [generate]

    - name: Show generator result
      ansible.builtin.debug:
        msg: "{{ gen_run.stdout | default('No generator run (dry-run mode).') }}"
      when: not (generate_inventory_dry_run | bool)
      tags: [generate]

  # Optional: make it easy to just run the "generate" step
  tags:
    - always
