---
# ---
# title: NSX Manager NTP â€“ Audit & Remediate (NSX 4.2.x)
# summary: Audits and remediates NTP servers using the Central Node Config Profile ("All NSX nodes").
# safe_dry_run: true
# idempotent: true
# references:
#   - GET/PUT /api/v1/configs/central-config/node-config-profiles
#   - GET/PUT /api/v1/configs/central-config/node-config-profiles/{id}
# ---

- name: Assert desired NTP servers present
  ansible.builtin.assert:
    that: nsx_ntp_servers | length > 0
    fail_msg: "nsx_ntp_servers is empty; set it in group_vars or -e."

- name: List Central Node Config Profiles
  ansible.builtin.uri:
    url: "{{ nsx_manager_url }}/api/v1/configs/central-config/node-config-profiles"
    method: GET
    force_basic_auth: true
    url_username: "{{ nsx_username }}"
    url_password: "{{ nsx_password }}"
    validate_certs: "{{ nsx_validate_certs }}"
  register: nsx_profiles

- name: Select 'All NSX nodes' profile
  ansible.builtin.set_fact:
    nsx_all_nodes_profile: >-
      {{ (nsx_profiles.json.results | default([]))
         | selectattr('display_name','equalto','All NSX nodes') | list | first }}

- name: Ensure 'All NSX nodes' profile exists
  ansible.builtin.assert:
    that:
      - nsx_all_nodes_profile is defined
      - nsx_all_nodes_profile.id is defined
    fail_msg: "Could not find Central Node Config Profile 'All NSX nodes'."

- name: Get current profile (with revision)
  ansible.builtin.uri:
    url: "{{ nsx_manager_url }}/api/v1/configs/central-config/node-config-profiles/{{ nsx_all_nodes_profile.id }}"
    method: GET
    force_basic_auth: true
    url_username: "{{ nsx_username }}"
    url_password: "{{ nsx_password }}"
    validate_certs: "{{ nsx_validate_certs }}"
  register: nsx_profile_current

- name: Compute NTP drift
  ansible.builtin.set_fact:
    current_ntp_servers: "{{ nsx_profile_current.json.ntp.servers | default([]) }}"
    ntp_drift: >-
      {{ (current_ntp_servers | sort) != (nsx_ntp_servers | sort) }}

- name: Dry-run | NTP drift summary
  ansible.builtin.debug:
    msg:
      current: "{{ current_ntp_servers }}"
      desired: "{{ nsx_ntp_servers }}"
      change_needed: "{{ ntp_drift }}"
  when: ansible_check_mode | bool

- name: Build proposed profile (NTP)
  ansible.builtin.set_fact:
    nsx_profile_proposed: >-
      {{ nsx_profile_current.json | combine({'ntp': {'servers': nsx_ntp_servers}}, recursive=True) }}

- name: Update Central Node Config Profile (NTP)
  ansible.builtin.uri:
    url: "{{ nsx_manager_url }}/api/v1/configs/central-config/node-config-profiles/{{ nsx_all_nodes_profile.id }}"
    method: PUT
    headers: { "Content-Type": "application/json" }
    body: "{{ nsx_profile_proposed | to_json }}"
    force_basic_auth: true
    url_username: "{{ nsx_username }}"
    url_password: "{{ nsx_password }}"
    validate_certs: "{{ nsx_validate_certs }}"
    status_code: [200]
  when:
    - not ansible_check_mode
    - ntp_drift
  changed_when: true

- name: No changes required for NTP
  ansible.builtin.debug:
    msg: "NTP already matches desired state."
  when: not ntp_drift
